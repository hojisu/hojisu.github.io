<script> MathJax.Hub.Queue(["Typeset",MathJax.Hub]); </script>

# 분산 분석(ANOVA; Analysis of Variance)과 모형 성능

### Summary

- 집단 간의 평균 차이를 검정할 때는 t 검정을 활용한다. 
- ANOVA는 3개 이상의 집단 간 평균을 검정할 때 사용하는 분석방법이다. 평균 차이를 비교하는데 분산의 개념을 활용한다. 집단의 평균들이 멀리 떨어져 분산이 크면 클수록 집단간의 평균들이 서로 다르기 때문이다. **집단 평균들 간의 분산이 클수록, 집단 내 분산이 작을수록 평균의 차이가 분명해진다.**
- (집단 간 평균 제곱)/(집단 내 평균 제곱)을 검정통계량 F라 하며, 이 차이가 통계적으로 유의한지를 분석함으로서, 평균이 모두 같다는 귀무가설을 검증하게 된다. 
______________

### 분산분석

분산분석(ANOVA : Analysis of Variance)은 종속변수의 분산과 독립변수의 분산간의 관계를 사용하여 선형회귀분석의 성능을 평가하고자 하는 방법이다. 서로 다른 두개의 선형회귀분석의 성능 비교에 응용할 수 있으며 독립변수가 카테고리 변수인 경우 각 카테고리 값에 따른 영향을 정량적으로 분석하는데도 사용된다.

**TSS(total sum of square)**는 종속변수 값의 움직임의 범위이다.

$$\bar{y}1_N$$ 는 $$\bar{y}$$ 이라는 스칼라가 N번 반복된 브로드캐스팅 벡터이다. 

  $$
  \text{TSS} = \sum_{i=1}^N (y_i-\bar{y})^2 = (y - \bar{y}1_N)^T(y - \bar{y}1_N)
  $$

**ESS(explained sum of squares)**는 회귀 분석에 의해 예측한 값 $$\hat y$$ 의 분산이다. **모형에서 나온 예측값의 움직임의 범위**이다.

$$\bar{\hat{y}}$$ 는 모형 예측값 $$\hat y$$ 의 평균이다.

$$
\text{ESS}=\sum_{i=1}^N (\hat{y}_i -\bar{\hat{y}})^2 = (\hat{y} - \bar{\hat{y}}1_N)^T(\hat{y} - \bar{\hat{y}}1_N)
$$

**RSS(residual sum of squares)**는 잔차 $$e$$ 의 분산이다. **잔차의 움직임의 범위(오차의 크기)**이다.

$$
\text{RSS}=\sum_{i=1}^N (y_i - \hat{y}_i)^2\ = e^Te
$$

만약 회귀모형이 상수항을 포함하여 올바르게 정의되었다면 잔차의 평균이 0이 된다. 즉, 종속변수의 평균과 모형 예측값의 평균이 같다.

이 분산값들 간에는 다음과 같은 관계가 성립한다.

  $$
  TSS = ESS + RSS
  $$

**모형 예측치의 움직임의 크기(분산)은 종속변수의 움직임의 크기(분산)보다 클 수 없다. 모형의 성능이 좋을수록 모형 예측치의 움직임의 크기는 종속변수의 움직임의 크기와 비슷해진다**

### 결정계수(Coefficient of Determination)

결정계수(Coefficient of Determination)는 모형의 성능을 나타내는 결정계수이다.

$$
R^2 \equiv 1 - \dfrac{\text{RSS}}{\text{TSS}}\ = \dfrac{\text{ESS}}{\text{TSS}}\
$$

$$
0 \leq R^2  \leq 1
$$

-여기에서 $$R^2$$가 0이라는 것은 오차의 분산 RSS가 최대이고 회귀분석 예측값의 분산 ESS가 0인 경우이므로 회귀분석 결과가 아무런 의미가 없다는 뜻이다. 반대로 $$R^2$$가 1이라는 것은 오차의 분산 RSS가 0이고 회귀분석 예측의 분산 ESS가 TSS와 같은 경우이므로 회귀분석 결과가 완벽하다는 뜻이다. 따라서 결정계수값은 회귀분석의 성능을 나타내는 수치라고 할 수 있다.

### 분산 분석표

분산 분석의 결과는 보통 다음과 같은 분산 분석표를 사용하여 표시한다. 아래의 표에서 N은 데이터의 갯수, K는 모수의 갯수를 뜻한다.

|   source   | degree of freedom | sum of square | mean square                               | F test-statstics                 | p-value |
| :--------: | :---------------: | :------------ | :---------------------------------------- | :------------------------------- | :------ |
| Regression |       $$K−1$$       | ESS           | $$s_{\hat{y}}^2 = \dfrac{\text{ESS}}{K-1}$$ | $$F=\dfrac{s_{\hat{y}}^2}{s_e^2}$$ | p-value |
|  Residual  |       $$N−K$$       | RSS           | $$s_e^2= \dfrac{\text{RSS}}{N-K}$$          |                                  |         |
|   Total    |       $$N−1$$       | TSS           | $$s_y^2= \dfrac{\text{TSS}}{N-1}$$          |                                  |         |
|   $$R^2$$    |                   | ESS/TSS       |                                           |                                  |         |

F 검정통계량과 유의확률은 모형 `summary` 명령으로 구한 `F-statistic` 및 `Prob (F-statistic)`과 일치한다.

### 회귀분석의 F-검정과 분산분석의 관계

분산분석의 결과를 이용하여 회귀분석 F-검정에 필요한 통계량을 구할 수 있다.

회귀분석의 F-검정의 귀무가설은 모든 $$w_i=0$$ 이다.  그럼 이 모형은 아무런 의미가 없으므로 $$R^2$$ (결정계수)은 0이 된다.

$$
H_0 : R^2=0
$$

이 때 $$\hat w$$값은 기대값이 0인 정규 분포에서 나온 표본이므로 예측값 $$\hat y = \hat w^T x$$는 정규 분포의 선형 조합이라서 마찬가지로 정규 분포를 따른다. 그리고 잔차(residual)는 오차(disturbance)의 선형 변환으로 정규 분포를 따르므로 ESS와 RSS의 비율은 F 분포를 따른다.

$$
\dfrac{\text{ESS}}{K-1} \div  \dfrac{\text{RSS}}{N-K} \sim F(K-1, N-K)
$$

### 결정 계수와 상관 계수

$$y$$와  $$\hat y $$의 샘플 상관계수 r의 제곱은 결정 계수 $$R^2$$와 같다.

### 상수항이 없는 모형의 경우

모형에서 상수항을 지정하지 않은 경우에는 결정계수의 정의에 사용되는 TSS의 정의가 다음과 같이 달라진다. 모형의 결정계수를 비교할 때 **상수항이 없는 모형과 상수항이 있는 모형은 직접 비교하면 안된다.**

$$
\text{TSS} = \sum_i y_i^2 = y^Ty
$$


### F 검정을 이용한 모형 비교

포함관계(nesting)에 있는 두 모형의 성능을 비교할 수 있다.

전체 모형(Full Model) : 

  $$
    y = w_0 + w_1 x_1 + w_2 x_2 + w_3 x_3
  $$

축소 모형(Reduced Model):
  $$
  y = w_0 + w_1 x_1
  $$

두 모형의 실질적으로 같은 모형이라는 가설을 검정하는 것과 같다.

  $$
    H_0: w_2 = w_3 = 0
  $$

이 검정도 F 검정을 사용하여 할 수 있다. StatsModels에서는 `anova_lm` 명령에 두 모형의 result 객체를 인수로 넣어주면 이러한 검정을 할 수 있다. 인수를 넣어줄 때는 축소 모형(reduced model), 전체 모형(full model)의 순서로 넣어준다.

### F 검정을 사용한 변수 중요도 비교

F 검정은 각 독립변수의 중요도를 비교하기 위해 사용할 수 있다. 

방법은 전체 모형과 각 변수 하나만을 뺀 모형들의 성능을 비교하는 것이다. 이는 간접적으로 각 독립 변수의 영향력을 측정하는 것과 같다.

`anova_lm` 명령에서는 `typ` 인수를 `2`로 지정하면 하나 하나의 변수를 뺀 축소 모형에서의 F 검정값을 한꺼번에 계산할 수 있다.

이 값은 단일 계수 t 검정의 유의확률과 동일하다. 그 이유는 다음과 같은 t 분포와 F 분포의 동치 성질 때문이다.

$$
t_n^2 = F_{(1, n)}
$$

### 조정 결정 계수

선형 회귀 모형에서 독립 변수가 추가되면 결정 계수의 값은 항상 증가한다. 독립 변수 추가 효과를 상쇄시키기 위한 다양한 기준들이 제시되었다. 그 중 하나가 다음과 같이 독립 변수의 갯수 $$K$$에 따라 결정 계수의 값을 조정하는 조정 결정 계수이다

### 정보량 규준

정보량 규준(information criterion)은 모형 비교 기준은 최대 가능도에 독립 변수의 갯수에 대한 손실(penalty)분을 반영하는 방법이다. 

AIC(Akaike Information Criterion)은 모형과 데이터의 확률 분포 사이의 Kullback-Leibler 수준을 가장 크게하기 위한 시도에서 나왔다

BIC (Bayesian Information Criterion)는 BIC는 데이터가 exponential family라는 가정하에 주어진 데이터에서 모형의 likelihood를 측정하기 위한 값에서 유도되었다.

둘 다 값이 작을 수록 올바른 모형에 가깝다.

$$
 \text{AIC} = -2\log L + 2K \\
 \text{BIC} = -2\log L + K\log n
$$

